<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tariff News Impact Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f1f5f9;
      margin: 0;
      padding: 30px;
      color: #1f2937;
    }
    .container {
      max-width: 1000px;
      margin: auto;
      background: #ffffff;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
    }
    h1 {
      font-size: 2.2rem;
      margin-bottom: 0.5rem;
      color: #111827;
    }
    p.description {
      font-size: 1.1rem;
      color: #4b5563;
      margin-bottom: 30px;
    }
    .form-group {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 30px;
    }
    select, button {
      padding: 12px 14px;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #d1d5db;
    }
    button {
      background-color: #2563eb;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.1s;
    }
    button:hover {
      background-color: #1d4ed8;
      transform: translateY(-1px);
    }
    #chart {
      background-color: #fff;
      padding: 10px;
      border-radius: 12px;
      box-shadow: inset 0 0 0 1px #e5e7eb;
    }
    h2 {
      font-size: 1.5rem;
      margin-top: 40px;
      margin-bottom: 20px;
      color: #1f2937;
    }
    .news-item {
      margin-bottom: 20px;
      padding: 18px 20px;
      border-left: 4px solid #2563eb;
      background-color: #f9fafb;
      border-radius: 10px;
      transition: background-color 0.2s;
    }
    .news-item:hover {
      background-color: #f3f4f6;
    }
    .news-item h3 {
      margin: 0;
      font-size: 1.1rem;
      color: #1e40af;
    }
    .news-item p {
      margin: 6px 0;
      font-size: 0.95rem;
      color: #374151;
    }
    .news-item a {
      color: #2563eb;
      font-weight: 500;
      text-decoration: none;
    }
    .news-item a:hover {
      text-decoration: underline;
    }
    .footer {
      margin-top: 60px;
      font-size: 0.9rem;
      color: #6b7280;
      text-align: center;
    }
    @media (max-width: 600px) {
      .form-group {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Tariff News Impact Dashboard</h1>
    <p class="description">
      Visualize how stock prices respond to major tariff and trade-related news events. Select a stock to analyze or compare them all. Built by Team 8.
    </p>

    <div class="form-group">
      <select id="stockSelect">
        <option value="AAPL">Apple (AAPL)</option>
        <option value="MSFT">Microsoft (MSFT)</option>
        <option value="TSLA">Tesla (TSLA)</option>
        <option value="GOOGL">Google (GOOGL)</option>
        <option value="AMZN">Amazon (AMZN)</option>
        <option value="ALL">All Stocks Combined</option>
      </select>
      <button onclick="pullData()">Pull Data</button>
    </div>

    <div id="chart" style="height: 500px;"></div>

    <h2>Recent Tariff News</h2>
    <div id="newsList"></div>

    <div class="footer">
      Dashboard powered by Yahoo Finance | Designed by Max & Team
    </div>
  </div>

  <script>
    const stockList = ['AAPL', 'MSFT', 'TSLA', 'GOOGL', 'AMZN'];

    async function pullData() {
      const symbol = document.getElementById("stockSelect").value;
      document.getElementById("chart").innerHTML = "Loading chart...";
      document.getElementById("newsList").innerHTML = "Loading news...";

      let chartData = [];
      if (symbol === "ALL") {
        for (const sym of stockList) {
          const data = await fetchYahooStock(sym);
          chartData.push({ symbol: sym, ...data });
        }
      } else {
        const data = await fetchYahooStock(symbol);
        chartData.push({ symbol, ...data });
      }

      const news = await fetchYahooNews();
      setChart(chartData, news);
      renderNews(news);
    }

    async function fetchYahooStock(symbol) {
      try {
        const res = await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=1mo&interval=1d`);
        const data = await res.json();
        const result = data.chart.result[0];
        const timestamps = result.timestamp;
        const prices = result.indicators.adjclose[0].adjclose;
        const dates = timestamps.map(ts => new Date(ts * 1000).toISOString().split('T')[0]);
        return { dates, prices };
      } catch (e) {
        console.error("Yahoo Finance stock fallback failed", e);
        return { dates: [], prices: [] };
      }
    }

    async function fetchYahooNews() {
      try {
        const proxy = "https://cors-anywhere.herokuapp.com/";
        const res = await fetch(`${proxy}https://finance.yahoo.com/news/search?p=tariff`);
        const html = await res.text();
        const matches = [...html.matchAll(/<a[^>]+href="([^"]+)"[^>]*>(.*?)<\/a>/g)];
        const articles = [];

        for (let i = 0; i < matches.length; i++) {
          const link = matches[i][1];
          const title = matches[i][2].replace(/<[^>]+>/g, "").trim();
          if (link.includes("/news/") && title && !title.includes("Yahoo")) {
            articles.push({
              title,
              url: `https://finance.yahoo.com${link}`,
              publishedAt: new Date().toISOString(),
              source: { name: "Yahoo Finance" }
            });
          }
          if (articles.length >= 5) break;
        }

        return articles;
      } catch (error) {
        console.error("Yahoo News fallback failed", error);
        return [{
          title: "Unable to fetch real news. Try again later.",
          url: "#",
          publishedAt: new Date().toISOString(),
          source: { name: "Fallback" }
        }];
      }
    }

    function setChart(dataArray, news) {
      const traces = dataArray.map(({ symbol, dates, prices }) => ({
        x: dates,
        y: prices,
        mode: 'lines+markers',
        name: symbol,
        type: 'scatter'
      }));

      const newsMarkers = news.map(article => {
        const date = new Date(article.publishedAt).toISOString().split("T")[0];
        return {
          x: [date],
          y: [null],
          mode: 'markers',
          name: 'News',
          text: [`${article.title}<br>${new Date(article.publishedAt).toLocaleDateString()}`],
          marker: { size: 10, color: 'red', symbol: 'diamond' },
          type: 'scatter'
        };
      });

      Plotly.newPlot("chart", [...traces, ...newsMarkers], {
        title: "Stock Price Over Time",
        xaxis: { title: "Date" },
        yaxis: { title: "Price (USD)" },
        legend: { orientation: "h", y: -0.2 }
      });
    }

    function renderNews(news) {
      const newsContainer = document.getElementById("newsList");
      newsContainer.innerHTML = "";

      if (!news.length) {
        newsContainer.innerHTML = "<p>No relevant news found at this time.</p>";
        return;
      }

      news.forEach(article => {
        const div = document.createElement("div");
        div.className = "news-item";
        div.innerHTML = `
          <h3>${article.title}</h3>
          <p><strong>${new Date(article.publishedAt).toLocaleDateString()}</strong> | ${article.source.name}</p>
          <a href="${article.url}" target="_blank">Read more</a>`;
        newsContainer.appendChild(div);
      });
    }
  </script>
</body>
</html>
